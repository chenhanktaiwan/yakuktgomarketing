<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¤Šæ¨‚å¤šéŠ·å”®å¯¦ç¸¾ç®¡ç†ç³»çµ± (Cloud D1ç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #7ba3a3;
            --primary-dark: #5d7f7f;
            --secondary-color: #a8c4a2;
            --success-color: #8fb58f;
            --danger-color: #c39ea0;
            --warning-color: #d4c19c;
            --white: #ffffff;
            --border-color: #e0e0dc;
            --shadow: 0 3px 10px rgba(123, 163, 163, 0.15);
            --growth-color: #4caf50;
            --decline-color: #f44336;
            --neutral-color: #9e9e9e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', 'Microsoft JhengHei', sans-serif; line-height: 1.6; color: #5a5a5a; background: linear-gradient(135deg, #f7f7f5 0%, #eeede9 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
        
        /* Navigation */
        .navbar { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: var(--white); padding: 1.5rem 0; box-shadow: var(--shadow); }
        .navbar .container { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .navbar-title { font-size: 1.8rem; font-weight: 300; letter-spacing: 1px; }
        .navbar-nav { display: flex; gap: 1rem; }
        .nav-btn { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3); color: var(--white); padding: 0.8rem 1.5rem; border-radius: 25px; cursor: pointer; transition: all 0.3s ease; }
        .nav-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-2px); }
        .nav-btn.active { background: var(--white); color: var(--primary-color); font-weight: 500; }

        /* Main Content */
        .main-content { padding: 3rem 0; }
        .section { display: none; animation: fadeIn 0.5s ease-in-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-header { text-align: center; margin-bottom: 3rem; }
        .section-header h2 { color: var(--primary-color); margin-bottom: 1rem; font-size: 2.5rem; font-weight: 300; }
        .section-header p { color: #666; font-size: 1.1rem; }

        /* Forms & Cards */
        .upload-form, .period-range-container, .comparison-container, .ranking-container, .detailed-comparison-table, .data-table-container { background: var(--white); padding: 2.5rem; border-radius: 20px; box-shadow: var(--shadow); margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.8rem; font-weight: 500; color: var(--primary-color); font-size: 1rem; }
        .form-control { width: 100%; padding: 1rem; border: 2px solid var(--border-color); border-radius: 12px; font-size: 1rem; background: rgba(255, 255, 255, 0.9); }
        
        /* Upload Zone */
        .upload-zone { border: 3px dashed var(--primary-color); border-radius: 20px; padding: 3rem; text-align: center; transition: all 0.3s ease; background: linear-gradient(135deg, rgba(123, 163, 163, 0.05) 0%, rgba(168, 196, 162, 0.05) 100%); margin: 2rem 0; }
        .upload-zone.drag-over { border-color: var(--success-color); background: rgba(143, 181, 143, 0.1); transform: scale(1.02); }

        /* Buttons */
        .btn { padding: 1rem 2rem; border: none; border-radius: 15px; cursor: pointer; font-size: 1rem; font-weight: 500; margin: 0.5rem; transition: all 0.3s ease; }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%); color: var(--white); box-shadow: 0 4px 15px rgba(123, 163, 163, 0.3); }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary-color) 0%, #95b58f 100%); color: var(--white); box-shadow: 0 4px 15px rgba(168, 196, 162, 0.3); }
        .btn-outline { background: transparent; border: 2px solid var(--primary-color); color: var(--primary-color); }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .form-actions { display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap; justify-content: center; }

        /* Stats & Tables */
        .summary-cards, .comparison-summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem; }
        .summary-card, .comparison-card { background: var(--white); padding: 2rem; border-radius: 20px; box-shadow: var(--shadow); text-align: center; border-left: 5px solid var(--primary-color); }
        .summary-value, .comparison-value { font-size: 2.2rem; color: var(--primary-dark); font-weight: bold; }
        
        /* Comparison specific */
        .comparison-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .period-selector { background: var(--white); padding: 2rem; border-radius: 15px; box-shadow: var(--shadow); }
        .period-selector.period-a { border-left: 5px solid var(--primary-color); }
        .period-selector.period-b { border-left: 5px solid var(--secondary-color); }
        .comparison-value.growth { color: var(--growth-color); }
        .comparison-value.decline { color: var(--decline-color); }
        .growth-indicator { padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.8rem; font-weight: 500; display: inline-block; }
        .growth-indicator.growth { background: rgba(76, 175, 80, 0.1); color: var(--growth-color); }
        .growth-indicator.decline { background: rgba(244, 67, 54, 0.1); color: var(--decline-color); }

        /* Table Scroll */
        .table-main-container { width: 100%; overflow-x: auto; max-height: 600px; border: 1px solid var(--border-color); }
        .products-table, .detailed-table, .ranking-table { width: 100%; border-collapse: collapse; min-width: 1000px; }
        th, td { padding: 0.8rem; border: 1px solid var(--border-color); text-align: center; }
        th { background: linear-gradient(135deg, rgba(123, 163, 163, 0.2) 0%, rgba(168, 196, 162, 0.2) 100%); position: sticky; top: 0; z-index: 10; }
        
        /* Storage Status */
        .storage-status { background: rgba(143, 181, 143, 0.1); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem; border-left: 4px solid var(--success-color); }
        
        /* Message Toasts */
        .success-message { background: var(--success-color); color: white; padding: 1rem; border-radius: 15px; margin: 1rem 0; text-align: center; }
        .error-message { background: var(--danger-color); color: white; padding: 1rem; border-radius: 15px; margin: 1rem 0; text-align: center; }
    </style>
    <script src="https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <h1 class="navbar-title">é¤Šæ¨‚å¤šéŠ·å”®å¯¦ç¸¾ç®¡ç†ç³»çµ± (Cloud D1ç‰ˆ)</h1>
            <div class="navbar-nav">
                <button class="nav-btn active" data-section="upload">ä¸Šå‚³è³‡æ–™</button>
                <button class="nav-btn" data-section="view">æŸ¥çœ‹å¯¦ç¸¾</button>
                <button class="nav-btn" data-section="analysis">å°æ¯”åˆ†æ</button>
            </div>
        </div>
    </nav>

    <main class="container main-content">
        <section id="upload-section" class="section active">
            <div class="section-header">
                <h2>ä¸Šå‚³æœˆä»½è³‡æ–™</h2>
                <p>è³‡æ–™å°‡å®‰å…¨å„²å­˜æ–¼é›²ç«¯è³‡æ–™åº« (é‡è¤‡ä¸Šå‚³å°‡è‡ªå‹•è¦†è“‹èˆŠè³‡æ–™)</p>
            </div>
            
            <div class="storage-status">
                <div class="storage-info" id="storage-info">
                    â˜ï¸ é›²ç«¯è³‡æ–™åº«ç‹€æ…‹ï¼š<span id="stored-months">æª¢æŸ¥ä¸­...</span><br>
                    <span id="stored-periods-list"></span>
                </div>
            </div>
            
            <div class="upload-form">
                <div class="form-group">
                    <label class="form-label">é¸æ“‡å¹´ä»½èˆ‡æœˆä»½</label>
                    <div style="display:flex; gap:1rem;">
                        <select id="upload-year" class="form-control">
                            <option value="2020">2020</option><option value="2021">2021</option><option value="2022">2022</option>
                            <option value="2023">2023</option><option value="2024">2024</option><option value="2025" selected>2025</option>
                            <option value="2026">2026</option><option value="2027">2027</option><option value="2028">2028</option>
                            <option value="2029">2029</option><option value="2030">2030</option>
                        </select>
                        <select id="upload-month" class="form-control">
                            <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                            <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                            <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09" selected>9æœˆ</option>
                            <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="upload-zone" id="upload-zone">
                        <p>æ‹–æ‹½ Excel æª”æ¡ˆåˆ°æ­¤è™•</p>
                        <input type="file" id="file-input" accept=".xlsx,.xls" hidden>
                        <button type="button" class="btn btn-outline" onclick="document.getElementById('file-input').click()">é¸æ“‡Excelæª”æ¡ˆ</button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" id="upload-btn" disabled>è™•ç†Excelæª”æ¡ˆ</button>
                    <button type="button" class="btn btn-outline" id="reload-cloud-btn">é‡æ–°è¼‰å…¥é›²ç«¯è³‡æ–™</button>
                </div>
                <div id="status-messages"></div>
            </div>
        </section>

        <section id="view-section" class="section">
            <div class="section-header"><h2>æŸ¥çœ‹å¯¦ç¸¾</h2></div>
            <div class="period-range-container">
                <h3 style="text-align:center; color:var(--primary-color);">æŸ¥è©¢ç¯„åœ</h3>
                <div style="display:flex; justify-content:center; gap:1rem; margin-top:1rem;">
                    <select id="start-year" class="form-control" style="width:auto;">
                        <option value="2024">2024å¹´</option><option value="2025" selected>2025å¹´</option><option value="2026">2026å¹´</option>
                    </select>
                    <select id="start-month" class="form-control" style="width:auto;">
                        <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                        <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                        <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09">9æœˆ</option>
                        <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                    </select>
                    <span>è‡³</span>
                    <select id="end-year" class="form-control" style="width:auto;">
                        <option value="2024">2024å¹´</option><option value="2025" selected>2025å¹´</option><option value="2026">2026å¹´</option>
                    </select>
                    <select id="end-month" class="form-control" style="width:auto;">
                        <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                        <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                        <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09" selected>9æœˆ</option>
                        <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" id="query-btn">æŸ¥è©¢è³‡æ–™</button>
                    <button type="button" class="btn btn-secondary" id="export-csv-btn">åŒ¯å‡º CSV</button>
                </div>
            </div>
            
            <div class="data-table-container">
                <div class="summary-cards">
                    <div class="summary-card"><h3>ç¸½é‡‘é¡ (å€é–“åˆè¨ˆ)</h3><div class="summary-value" id="total-revenue">-</div></div>
                    <div class="summary-card"><h3>ç¸½è¨‚å–®æ•¸ (å€é–“åˆè¨ˆ)</h3><div class="summary-value" id="total-orders">-</div></div>
                </div>
                
                <div class="table-main-container">
                    <table class="products-table">
                        <thead><tr id="table-header-row"><th>ç”¢å“åç¨±</th></tr></thead>
                        <tbody id="products-table-body"><tr><td class="no-data">è«‹æŸ¥è©¢è³‡æ–™</td></tr></tbody>
                    </table>
                </div>
            </div>
        </section>

        <section id="analysis-section" class="section">
            <div class="section-header"><h2>å°æ¯”åˆ†æ</h2></div>
            <div class="comparison-container">
                <div class="period-selector period-a">
                    <h3>åŸºæº–æœŸé–“ (A)</h3>
                    <select id="period-a-year" class="form-control"><option value="2025">2025å¹´</option></select>
                    <select id="period-a-month" class="form-control">
                        <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                        <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                        <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09">9æœˆ</option>
                        <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                    </select>
                </div>
                <div class="period-selector period-b">
                    <h3>å°æ¯”æœŸé–“ (B)</h3>
                    <select id="period-b-year" class="form-control"><option value="2025">2025å¹´</option></select>
                    <select id="period-b-month" class="form-control">
                        <option value="01">1æœˆ</option><option value="02">2æœˆ</option><option value="03">3æœˆ</option>
                        <option value="04">4æœˆ</option><option value="05">5æœˆ</option><option value="06">6æœˆ</option>
                        <option value="07">7æœˆ</option><option value="08">8æœˆ</option><option value="09">9æœˆ</option>
                        <option value="10">10æœˆ</option><option value="11">11æœˆ</option><option value="12">12æœˆ</option>
                    </select>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-primary" id="compare-btn">é–‹å§‹å°æ¯”</button>
            </div>
            <div id="comparison-results" style="display:none; margin-top:2rem;">
                <div class="comparison-summary-cards">
                    <div class="comparison-card"><h3>ç‡Ÿæ”¶è®ŠåŒ–</h3><div class="comparison-value" id="revenue-comparison">-</div></div>
                    <div class="comparison-card"><h3>è¨‚å–®è®ŠåŒ–</h3><div class="comparison-value" id="orders-comparison">-</div></div>
                </div>
                <div class="detailed-comparison-table">
                    <h3>ç”¢å“è©³ç´°å°æ¯”</h3>
                    <div class="table-main-container">
                        <table class="detailed-table">
                            <thead><tr><th>ç”¢å“</th><th>æœŸé–“A</th><th>æœŸé–“B</th><th>å·®ç•°</th><th>æˆé•·ç‡</th></tr></thead>
                            <tbody id="detailed-comparison-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        let salesData = [];
        let filteredData = [];
        let uploadedFile = null;
        const SPECIFIED_LOCATIONS = ['ç¸½è¨ˆ', 'åŸºéš†', 'å‰æ—', 'å¤§åŒ', 'ä¸‰é‡', 'å¤äº­', 'æ–°èŠ', 'æ¡ƒåœ’', 'å®œè˜­', 'ç¾…æ±', 'ä¸‰é‡å®…é…', 'ä¸­å±±å®…é…', 'ç›Šæ¨‚å¤šæ–°ç«¹', 'ç›Šæ¨‚å¤šä¸­å£¢', 'ä½³æ¨‚å¤š', 'å„ªæ¨‚å¤š', 'é›²æ—', 'é«˜æ¨‚å¤šä¸‰æ°‘', 'é«˜æ¨‚å¤šé³³å±±', 'èŠ±è“®', 'è‹—æ —', 'å½°åŒ–', 'å˜‰ç¾©', 'å°å—', 'å±æ±', 'é¤Šæ¨‚é£Ÿå“'];
        const LOCATION_MAPPING = {'æ–°ç«¹å¸‚':'ç›Šæ¨‚å¤šæ–°ç«¹', 'ä¸­å£¢':'ç›Šæ¨‚å¤šä¸­å£¢', 'è±åŸ':'ä½³æ¨‚å¤š', 'å—å€':'å„ªæ¨‚å¤š', 'ä¸‰æ°‘':'é«˜æ¨‚å¤šä¸‰æ°‘', 'é³³å±±':'é«˜æ¨‚å¤šé³³å±±'};
        const SKIP_COLS = ['é›…å¯æ¨‚å¤šå…¬å¸åˆè¨ˆ', 'å„ªæ¨‚å¤šå…¬å¸å°è¨ˆ', 'é«˜æ¨‚å¤šå…¬å¸åˆè¨ˆ', 'ç›Šæ¨‚å¤šå…¬å¸åˆè¨ˆ', 'ä½³æ¨‚å¤šå…¬å¸åˆè¨ˆ', 'ç¶“éŠ·è™•åˆè¨ˆ'];
        
        // â­ï¸ æ¨™æº–ç”¢å“é †åº (ç”¨æ–¼æ’åº)
        const ALL_PRODUCTS = [
            "é¤Šæ¨‚å¤š", "é¤Šæ¨‚å¤š300LIGHT", "é¤Šæ¨‚å¤š300", "æ–°é¤Šæ¨‚å¤š", "å„ªé…ªä¹³åŸå‘³",
            "å„ªé…ªä¹³è‰è“", "å„ªé…ªä¹³Light", "å„ªé…ªä¹³ç„¡åŠ ç³–", "å…¨è„‚é®®ä¹³", "é«˜ç´šé®®ä¹³",
            "å’–å•¡ç‰›å¥¶", "å·§å…‹åŠ›ç‰›å¥¶", "ç‰¹é¸ç¶ å¥¶èŒ¶", "100%è˜‹æœæ±", "100%æŸ³æ©™ç¶œåˆæœæ±",
            "é¤Šæ¨‚å¤šé‡èœç¶œåˆè”¬æœæ±", "é¤Šæ¨‚å¤šé‡èœç¶œåˆè”¬æœæ± è˜‹æœï¼†ç´…è˜¿è””",
            "é¤Šæ¨‚å¤šé‡èœç¶œåˆè”¬æœæ± ç™½è‘¡è„ï¼†è èœ", "é¤Šæ¨‚å¤šé‡èœç¶œåˆè”¬æœæ± ç´«è‰²è”¬æœ",
            "é¤Šæ¨‚å¤šé®®è±†æ¼¿", "è¶…ç„¡é™é‹å‹•é£²æ–™", "é¤Šæ¨‚å¤šå¤©ç„¶æ°´0.6L", "è•ƒçˆ½éº—èŒ¶", "é¤Šæ¨‚å¤šé»‘é†‹",
            "é¤Šæ¨‚å¤šå„ªæ ¼ç¢³é…¸é£²æ–™", "My Time è† åŸå¸ƒä¸", "ä¹¾éºµç‰©èªæ“”æ“”éºµ", "ä¹¾éºµç‰©èªé­šä»‹é†¬æ²¹æ²¾éºµ",
            "ä¹¾éºµç‰©èªè±šéª¨é†¬æ²¹æ‹‰éºµ", "éºµè¨±çš†å‚³é†¬æ²¹", "éºµè¨±çš†å‚³é¹½å‘³", "éºµè¨±çš†å‚³è±šéª¨",
            "å‹å±‹æ¿¾æ³¡ç ”ç£¨å’–å•¡", "å‹å±‹æ¿¾æ³¡ç ”ç£¨å’–å•¡ç¦®ç›’", "é¤Šæ¨‚å¤šé †æš¢é’æ±", "é¤Šæ¨‚å¤šæˆ‘çš„é’æ±-30åŒ…",
            "é¤Šæ¨‚å¤šç¾½è¡£ç”˜è—è”¬æœæ˜”", "é¤Šæ¨‚å¤šè‘¡è„ç³–èƒº", "é¤Šæ¨‚å¤šé­šæ²¹", "é¤Šæ¨‚å¤šè­·æ‰‹éœœ",
            "MOMMY é¦¬å…‹æ¯", "ç¦®ç›’W01"
        ];

        document.addEventListener('DOMContentLoaded', () => {
            setupNavigation();
            setupFileUpload();
            setupEventListeners();
            loadFromCloudflare();
        });

        async function uploadToCloudflare(processedData) {
            const btn = document.getElementById('upload-btn');
            btn.disabled = true; btn.textContent = 'â˜ï¸ ä¸Šå‚³ä¸­...';
            try {
                const payload = processedData.map(item => ({
                    year: parseInt(item.month.split('-')[0]),
                    month: parseInt(item.month.split('-')[1]),
                    region: item.location,
                    product: item.product_name,
                    metric: item.metric_type,
                    value: item.value
                }));
                const res = await fetch('/api/records', { method: 'POST', body: JSON.stringify(payload) });
                if(res.ok) { showMsg('âœ… ä¸Šå‚³æˆåŠŸï¼', 'success'); await loadFromCloudflare(); }
                else { showMsg('âŒ ä¸Šå‚³å¤±æ•—: ' + await res.text(), 'error'); }
            } catch(e) { console.error(e); showMsg('âŒ ç¶²è·¯éŒ¯èª¤', 'error'); }
            finally { btn.disabled = false; btn.textContent = 'è™•ç†Excelæª”æ¡ˆ'; }
        }

        // 2. å¾ Cloudflare è®€å– (â­ï¸ å¼·åˆ¶å»é‡é‚è¼¯)
        async function loadFromCloudflare() {
            document.getElementById('stored-months').textContent = "è¼‰å…¥ä¸­...";
            try {
                const res = await fetch('/api/records');
                if(!res.ok) throw new Error("API Error");
                let cloudData = await res.json();
                
                // 1. å…ˆæŒ‰ ID å€’åºæ’åˆ— (IDè¶Šå¤§ = è¶Šæ™šåŒ¯å…¥ = è¶Šæ–°)
                cloudData.sort((a, b) => b.id - a.id);

                // 2. ä½¿ç”¨ Map é€²è¡Œåš´æ ¼å»é‡ï¼šKey = "å¹´-æœˆ-åœ°å€-ç”¢å“-æŒ‡æ¨™"
                // ç”±æ–¼å·²ç¶“æ˜¯å€’åºï¼ŒMap.set æœƒä¿ç•™é‡åˆ°çš„ç¬¬ä¸€ç­† (ä¹Ÿå°±æ˜¯æœ€æ–°çš„)ï¼ŒèˆŠçš„åŒ Key è³‡æ–™æœƒè¢«å¿½ç•¥
                const uniqueMap = new Map();
                cloudData.forEach(item => {
                    const key = `${item.year}-${item.month}-${item.region}-${item.product}-${item.metric}`;
                    if(!uniqueMap.has(key)) {
                        uniqueMap.set(key, item);
                    }
                });

                // 3. è½‰å›é™£åˆ—
                const cleanData = Array.from(uniqueMap.values());
                
                salesData = cleanData.map(item => ({
                    month: `${item.year}-${String(item.month).padStart(2,'0')}`,
                    metric_type: item.metric,
                    product_name: item.product,
                    location: item.region,
                    value: item.value
                }));
                
                const months = [...new Set(salesData.map(d => d.month))].sort().join(', ');
                document.getElementById('stored-months').textContent = salesData.length > 0 ? `${[...new Set(salesData.map(d => d.month))].length} å€‹æœˆä»½` : "0";
                document.getElementById('stored-periods-list').textContent = months ? `(${months})` : "";
            } catch(e) {
                document.getElementById('storage-info').innerHTML = "<span style='color:red'>âŒ ç„¡æ³•é€£æ¥é›²ç«¯è³‡æ–™åº«</span>";
                console.error("è¼‰å…¥å¤±æ•—", e);
            }
        }

        async function processExcelFile() {
            if(!uploadedFile) return showMsg('è«‹é¸æ“‡æª”æ¡ˆ', 'error');
            const btn = document.getElementById('upload-btn');
            btn.textContent = 'è®€å–ä¸­...';
            
            try {
                const data = await readFile(uploadedFile);
                const workbook = XLSX.read(data, {type:'array'});
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const json = XLSX.utils.sheet_to_json(sheet, {header:1});
                
                const year = document.getElementById('upload-year').value;
                const month = document.getElementById('upload-month').value;
                const monthKey = `${year}-${month}`;
                
                const processed = [];
                const headers = json[0] || [];

                // æŠ“å–å„å€çš„ã€Œè¨‚å–®ç­†æ•¸ã€(Row 2)
                if (json.length > 1) {
                    const row = json[1];
                    for (let j = 2; j < row.length && j < headers.length; j++) {
                        let loc = headers[j];
                        if (!loc || SKIP_COLS.includes(loc)) continue;
                        loc = LOCATION_MAPPING[loc] || loc;
                        const val = parseInt(row[j]) || 0;
                        if (val > 0) processed.push({month:monthKey, metric_type:'è¨‚å–®ç­†æ•¸', product_name:'è¨‚å–®ç­†æ•¸', location:loc, value:val});
                    }
                }

                // æŠ“å–å„å€çš„ã€Œè¨‚å–®é‡‘é¡ã€(Row 3)
                if (json.length > 2) {
                    const row = json[2];
                    for (let j = 2; j < row.length && j < headers.length; j++) {
                        let loc = headers[j];
                        if (!loc || SKIP_COLS.includes(loc)) continue;
                        loc = LOCATION_MAPPING[loc] || loc;
                        const val = parseInt(row[j]) || 0;
                        if (val > 0) processed.push({month:monthKey, metric_type:'è¨‚å–®é‡‘é¡', product_name:'è¨‚å–®é‡‘é¡', location:loc, value:val});
                    }
                }

                // è®€å–ç”¢å“ (å¾ç¬¬4åˆ—é–‹å§‹)
                for(let i=3; i<json.length; i++) {
                    const row = json[i];
                    if(!row || !row[0] || !row[1]) continue;
                    const metric = row[0]; 
                    const product = row[1];
                    if(metric !== 'è¨‚è³¼æ•¸é‡' && metric !== 'è´ˆé€æ•¸é‡') continue;

                    for(let j=2; j<row.length; j++) {
                        let loc = headers[j];
                        if(!loc || SKIP_COLS.includes(loc)) continue;
                        loc = LOCATION_MAPPING[loc] || loc;
                        const val = parseInt(row[j]) || 0;
                        if(val > 0) processed.push({month:monthKey, metric_type:metric, product_name:product, location:loc, value:val});
                    }
                }
                
                await uploadToCloudflare(processed);
            } catch(e) {
                console.error(e);
                showMsg('æª”æ¡ˆè™•ç†å¤±æ•—: ' + e.message, 'error');
                btn.textContent = 'è™•ç†Excelæª”æ¡ˆ';
            }
        }

        function queryData() {
            const sy = document.getElementById('start-year').value, sm = document.getElementById('start-month').value;
            const ey = document.getElementById('end-year').value, em = document.getElementById('end-month').value;
            const start = `${sy}-${sm}`, end = `${ey}-${em}`;
            
            filteredData = salesData.filter(d => d.month >= start && d.month <= end);
            if(filteredData.length === 0) return showMsg('æŸ¥ç„¡è³‡æ–™', 'error');

            const orders = filteredData.filter(d => d.product_name === 'è¨‚å–®ç­†æ•¸' && d.location === 'ç¸½è¨ˆ').reduce((s,i) => s+i.value, 0);
            const rev = filteredData.filter(d => d.product_name === 'è¨‚å–®é‡‘é¡' && d.location === 'ç¸½è¨ˆ').reduce((s,i) => s+i.value, 0);
            document.getElementById('total-orders').textContent = orders.toLocaleString();
            document.getElementById('total-revenue').textContent = rev.toLocaleString();

            updateTable(filteredData);
            showMsg(`æŸ¥è©¢å®Œæˆ: ${start} ~ ${end}`, 'success');
        }

        function updateTable(data) {
            const tbody = document.getElementById('products-table-body');
            const thead = document.getElementById('table-header-row');
            
            let thHtml = '<th>ç”¢å“åç¨±</th>';
            SPECIFIED_LOCATIONS.forEach(loc => thHtml += `<th>${loc}</th>`);
            thead.innerHTML = thHtml;

            let html = '';

            // 1. ç¸½è¡¨è³‡è¨Š
            html += `<tr style="background:#e3f2fd; font-weight:bold; color:#0d47a1; text-align:left;"><td colspan="${SPECIFIED_LOCATIONS.length + 1}">ğŸ“Š ç¸½è¡¨è³‡è¨Š (è¨‚å–®èˆ‡é‡‘é¡)</td></tr>`;
            
            ['è¨‚å–®ç­†æ•¸', 'è¨‚å–®é‡‘é¡'].forEach(metric => {
                const rowData = data.filter(d => d.product_name === metric);
                html += `<tr><td style="text-align:left; font-weight:bold; background:#f5f5f5;">${metric}</td>`;
                SPECIFIED_LOCATIONS.forEach(loc => {
                    const val = rowData.filter(d => d.location === loc).reduce((s,i) => s+i.value, 0);
                    let style = 'color:#ccc;';
                    if (loc === 'ç¸½è¨ˆ') style = 'color:#d32f2f; font-weight:bold; font-size:1.1em;';
                    else if (val > 0) style = 'color:#333; font-weight:500;';
                    html += `<td style="${style}">${val > 0 ? val.toLocaleString() : '-'}</td>`;
                });
                html += '</tr>';
            });

            // 2. ç”¢å“æ˜ç´° (â­ï¸ ä¿®æ­£ï¼šä¾æ“š ALL_PRODUCTS é †åºé€²è¡Œæ’åºï¼Œé˜²æ­¢å€’åº)
            let products = [...new Set(data.filter(d => d.metric_type === 'è¨‚è³¼æ•¸é‡').map(d => d.product_name))];
            
            products.sort((a, b) => {
                const indexA = ALL_PRODUCTS.indexOf(a);
                const indexB = ALL_PRODUCTS.indexOf(b);
                // å¦‚æœæ‰¾ä¸åˆ°ç”¢å“(indexç‚º-1)ï¼ŒæŠŠå®ƒæ”¾åˆ°æœ€å¾Œé¢
                return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
            });
            
            ['è¨‚è³¼æ•¸é‡', 'è´ˆé€æ•¸é‡'].forEach(metric => {
                html += `<tr style="background:#eee; font-weight:bold;"><td colspan="${SPECIFIED_LOCATIONS.length+1}">${metric}</td></tr>`;
                products.forEach(prod => {
                    const rowData = data.filter(d => d.product_name === prod && d.metric_type === metric);
                    if(rowData.length === 0) return;
                    
                    html += `<tr><td style="text-align:left;">${prod}</td>`;
                    SPECIFIED_LOCATIONS.forEach(loc => {
                        const val = rowData.filter(d => d.location === loc).reduce((s,i) => s+i.value, 0);
                        html += `<td style="color:${val>0?'#333':'#ccc'}">${val>0?val.toLocaleString():'-'}</td>`;
                    });
                    html += '</tr>';
                });
            });
            tbody.innerHTML = html || '<tr><td colspan="100">ç„¡è³‡æ–™</td></tr>';
        }

        function compareData() {
            const pa = `${document.getElementById('period-a-year').value}-${document.getElementById('period-a-month').value}`;
            const pb = `${document.getElementById('period-b-year').value}-${document.getElementById('period-b-month').value}`;
            
            const da = salesData.filter(d => d.month === pa), db = salesData.filter(d => d.month === pb);
            if(da.length === 0 || db.length === 0) return showMsg('è³‡æ–™ä¸è¶³ï¼Œç„¡æ³•å°æ¯”', 'error');

            const revA = da.filter(d => d.product_name === 'è¨‚å–®é‡‘é¡' && d.location === 'ç¸½è¨ˆ').reduce((s,i) => s+i.value, 0);
            const revB = db.filter(d => d.product_name === 'è¨‚å–®é‡‘é¡' && d.location === 'ç¸½è¨ˆ').reduce((s,i) => s+i.value, 0);
            const revDiff = revB - revA;
            const revRate = revA ? (revDiff/revA)*100 : 0;
            
            const ordA = da.filter(d => d.product_name === 'è¨‚å–®ç­†æ•¸' && d.location === 'ç¸½è¨ˆ').reduce((s,i) => s+i.value, 0);
            const ordB = db.filter(d => d.product_name === 'è¨‚å–®ç­†æ•¸' && d.location === 'ç¸½è¨ˆ').reduce((s,i) => s+i.value, 0);
            const ordDiff = ordB - ordA;

            document.getElementById('comparison-results').style.display = 'block';
            document.getElementById('revenue-comparison').innerHTML = `${revRate.toFixed(1)}% <span style="font-size:1rem;color:#666">(${revDiff>0?'+':''}${revDiff.toLocaleString()})</span>`;
            document.getElementById('revenue-comparison').className = `comparison-value ${revRate>=0?'growth':'decline'}`;
            document.getElementById('orders-comparison').textContent = `${ordDiff>0?'+':''}${ordDiff} ç­†`;

            const products = [...new Set([...da, ...db].filter(d => d.metric_type === 'è¨‚è³¼æ•¸é‡').map(d => d.product_name))];
            let html = '';
            products.forEach(prod => {
                const valA = da.filter(d => d.product_name === prod && d.metric_type === 'è¨‚è³¼æ•¸é‡').reduce((s,i) => s+i.value, 0);
                const valB = db.filter(d => d.product_name === prod && d.metric_type === 'è¨‚è³¼æ•¸é‡').reduce((s,i) => s+i.value, 0);
                const diff = valB - valA;
                const rate = valA ? (diff/valA)*100 : (valB?100:0);
                
                html += `<tr>
                    <td style="text-align:left">${prod}</td>
                    <td>${valA.toLocaleString()}</td><td>${valB.toLocaleString()}</td>
                    <td style="color:${diff>=0?'green':'red'}">${diff>0?'+':''}${diff.toLocaleString()}</td>
                    <td><span class="growth-indicator ${rate>=0?'growth':'decline'}">${rate.toFixed(1)}%</span></td>
                </tr>`;
            });
            document.getElementById('detailed-comparison-body').innerHTML = html;
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.section + '-section').classList.add('active');
                }
            });
        }
        function setupFileUpload() {
            const zone = document.getElementById('upload-zone'), input = document.getElementById('file-input');
            zone.ondragover = e => { e.preventDefault(); zone.classList.add('drag-over'); };
            zone.ondragleave = () => zone.classList.remove('drag-over');
            zone.ondrop = e => { e.preventDefault(); zone.classList.remove('drag-over'); validateFile(e.dataTransfer.files[0]); };
            input.onchange = e => validateFile(e.target.files[0]);
        }
        function setupEventListeners() {
            document.getElementById('upload-btn').onclick = processExcelFile;
            document.getElementById('reload-cloud-btn').onclick = loadFromCloudflare;
            document.getElementById('query-btn').onclick = queryData;
            document.getElementById('compare-btn').onclick = compareData;
        }
        function validateFile(file) {
            if(!file || (!file.name.endsWith('.xls') && !file.name.endsWith('.xlsx'))) return showMsg('æ ¼å¼éŒ¯èª¤', 'error');
            uploadedFile = file;
            document.getElementById('upload-btn').disabled = false;
            showMsg(`å·²é¸æ“‡: ${file.name}`, 'success');
        }
        function readFile(file) {
            return new Promise((resolve,reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }
        function showMsg(txt, type) {
            const d = document.createElement('div');
            d.className = type === 'error' ? 'error-message' : 'success-message';
            d.textContent = txt;
            document.getElementById('status-messages').appendChild(d);
            setTimeout(() => d.remove(), 3000);
        }
    </script>
</body>
</html>
